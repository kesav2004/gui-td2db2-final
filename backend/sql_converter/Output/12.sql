CREATE OR REPLACE PROCEDURE DG_I_O_40ANA_CBC.PROC_PROCESS_DELTAS( 
 IN par_COG_RUN_ID INTEGER, 
 IN par_ETL_RUN_ID INTEGER, 
 IN par_PROC_NR INTEGER, 
 OUT par_STATUS INTEGER) 
 LANGUAGE SQL
 BEGIN 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 DECLARE par_ZERO_ROWS, par_MAX_ETL_RUN_ID, par_ACT_INS, par_ACT_UPD, par_STEP, par_ERI_PROC, par_ERI_PROC_MS INTEGER DEFAULT 0; 
 DECLARE par_SQLSTATE CHARACTER(5); 
 DECLARE par_SQLMSG VARCHAR(118);
     DECLARE done INT DEFAULT 0; 
 
 
 
 DECLARE EXIT HANDLER FOR SQLEXCEPTION 
 BEGIN 
 
 
 
 GET DIAGNOSTICS EXCEPTION 1 par_SQLMSG = MESSAGE_TEXT; 
 
 
 ROLLBACK; 
 
 
 UPDATE DG_I_O_40ANA_CBC.DpCBCD_runcontrol_30 
 SET END_DATE = CURRENT TIMESTAMP 
 , RUN_RESULT = 'ERROR' 
 , RUN_COMMENT = COALESCE(RUN_COMMENT, '') || 'SQLEXCEPTION after step ' || TRIM(par_STEP) || ': ' || par_SQLMSG || '; ' 
 , ETL_RUN_ID_INT = 0 
 WHERE COG_RUN_ID = par_COG_RUN_ID 
 AND PROCEDURE_NUMBER = par_PROC_NR 
 AND PROCEDURE_NAME = 'PROC_PROCESS_DELTAS'; 
 
 SET par_STATUS = 1; 
 END; 
 
 
 DECLARE EXIT HANDLER FOR SQLWARNING 
 BEGIN 
 
 SET par_SQLSTATE = SqlState; 
 
 
 ROLLBACK; 
 
 
 UPDATE DG_I_O_40ANA_CBC.DpCBCD_runcontrol_30 
 SET END_DATE = CURRENT TIMESTAMP 
 , RUN_RESULT = 'ERROR' 
 , RUN_COMMENT = COALESCE(RUN_COMMENT, '') || 'SQLWARNING sqlstate: ' || par_SQLSTATE || ' after step ' || TRIM(par_STEP) || '; ' 
 , ETL_RUN_ID_INT = 0 
 WHERE COG_RUN_ID = par_COG_RUN_ID 
 AND PROCEDURE_NUMBER = par_PROC_NR 
 AND PROCEDURE_NAME = 'PROC_PROCESS_DELTAS'; 
 
 SET par_STATUS = 1; 
 END; 
 
 
 DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' 
 BEGIN 
 
 
 SET par_ZERO_ROWS = par_ZERO_ROWS + 1; 
 
 UPDATE DG_I_O_40ANA_CBC.DpCBCD_runcontrol_30 
 SET RUN_COMMENT = ' 0 rows updated for ' || CAST(par_ZERO_ROWS AS VARCHAR(2)) || ' queries; ' 
 WHERE COG_RUN_ID = par_COG_RUN_ID 
 AND PROCEDURE_NUMBER = par_PROC_NR 
 AND PROCEDURE_NAME = 'PROC_PROCESS_DELTAS'; 
 END; 
 
 
 DECLARE EXIT HANDLER FOR NOT FOUND 
 BEGIN 
 
 SET par_SQLSTATE = SqlState; 
 
 
 ROLLBACK; 
 
 
 UPDATE DG_I_O_40ANA_CBC.DpCBCD_runcontrol_30 
 SET END_DATE = CURRENT TIMESTAMP 
 , RUN_RESULT = 'ERROR' 
 , RUN_COMMENT = COALESCE(RUN_COMMENT, '') || 'SQL NOT FOUND sqlstate: ' || par_SQLSTATE || ' after step ' || TRIM(par_STEP) || '; ' 
 , ETL_RUN_ID_INT = 0 
 WHERE COG_RUN_ID = par_COG_RUN_ID 
 AND PROCEDURE_NUMBER = par_PROC_NR 
 AND PROCEDURE_NAME = 'PROC_PROCESS_DELTAS'; 
 
 SET par_STATUS = 1; 
 END; 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_runcontrol_30 (COG_RUN_ID, PROCEDURE_NUMBER, PROCEDURE_NAME, START_DATE) 
 VALUES (par_COG_RUN_ID, par_PROC_NR, 'PROC_PROCESS_DELTAS', CURRENT TIMESTAMP); 
 
 
 SELECT COALESCE(MAX(ETL_RUN_ID),0) INTO par_ERI_PROC_MS 
 FROM DG_I_O_40ANA_CBC.DpCBCD_msg_spec 
 WHERE TRANSMITTINGCOUNTRY <> 'NL'; 
 
 
 
 
 IF par_ETL_RUN_ID < par_ERI_PROC_MS THEN 
 SET par_ERI_PROC = par_ERI_PROC_MS; 
 ELSE 
 SET par_ERI_PROC = par_ETL_RUN_ID; 
 END IF; 
 
 
 
 BEGIN 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_msg_spec( 
 "SENDINGENTITYIN" 
 , "SENDINGENTITYNAME" 
 , "TRANSMITTINGCOUNTRY" 
 , "MESSAGETYPE" 
 , "LANGUAGE" 
 , "WARNING" 
 , "CONTACT" 
 , "EULOCALFILING" 
 , "EUINCOMPLETE" 
 , "MESSAGEREFID" 
 , "MESSAGETYPEINDIC" 
 , "REPORTINGPERIOD" 
 , "TIMESTAMP" 
 , "RELNR" 
 , "USEDSOFTWAREPACKAGE" 
 , "X_BERICHTID" 
 , "X_ONTVANGSTDATUMTIJD" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT 
 M."SENDINGENTITYIN", 
 M."SENDINGENTITYNAME", 
 M."TRANSMITTINGCOUNTRY", 
 M."MESSAGETYPE", 
 M."LANGUAGE", 
 M."WARNING", 
 M."CONTACT", 
 M."EULOCALFILING", 
 M."EUINCOMPLETE", 
 M."MESSAGEREFID", 
 M."MESSAGETYPEINDIC", 
 M."REPORTINGPERIOD", 
 M."TIMESTAMP", 
 M."RELNR", 
 M."USEDSOFTWAREPACKAGE", 
 M."X_BERICHTID", 
 M."X_ONTVANGSTDATUMTIJD", 
 M."ETL_RUN_ID", 
 M."ETL_STG_TIMESTAMP", 
 M.X_ONTVANGSTDATUMTIJD AS "START_DATE" 
 , 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_msg_spec AS M 
 WHERE M.ETL_RUN_ID > par_ERI_PROC; 
 
 SET par_ACT_INS = Activity_Count; 
 SET par_STEP = 1; 
 
 
 
 
 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_msg_spec_rec_cntry( 
 "MESSAGEREFID" 
 , "SENDINGENTITYIN" 
 , "TRANSMITTINGCOUNTRY" 
 , "RECEIVINGCOUNTRY" 
 , "VOLGNR" 
 , "VOLGNR_COG" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT S."MESSAGEREFID" 
 , S."SENDINGENTITYIN" 
 , S."TRANSMITTINGCOUNTRY" 
 , S."RECEIVINGCOUNTRY" 
 , S."VOLGNR" 
 , RANK() OVER (PARTITION BY S.MESSAGEREFID, S.SENDINGENTITYIN, S.TRANSMITTINGCOUNTRY, S.ETL_RUN_ID 
 ORDER BY S.VOLGNR) AS "VOLGNR_COG" 
 , S."ETL_RUN_ID" 
 , S."ETL_STG_TIMESTAMP" 
 , P.X_ONTVANGSTDATUMTIJD AS "START_DATE" 
 , NULL AS "END_DATE" 
 , 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_msg_spec_rec_cntry AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS P 
 ON S.MESSAGEREFID = P.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 WHERE S.ETL_RUN_ID > par_ERI_PROC; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 2; 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_msg_spec_corr_msg( 
 "MESSAGEREFID" 
 , "SENDINGENTITYIN" 
 , "TRANSMITTINGCOUNTRY" 
 ,"CORRMESSAGEREFID" 
 , "VOLGNR" 
 , "VOLGNR_COG" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT 
 S."MESSAGEREFID" 
 , S."SENDINGENTITYIN" 
 , S."TRANSMITTINGCOUNTRY" 
 , S."CORRMESSAGEREFID" 
 , S."VOLGNR" 
 , RANK() OVER (PARTITION BY 
 S.MESSAGEREFID 
 , S.SENDINGENTITYIN 
 , S.TRANSMITTINGCOUNTRY 
 , S.ETL_RUN_ID 
 ORDER BY S.VOLGNR) AS "VOLGNR_COG" 
 , S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 P.X_ONTVANGSTDATUMTIJD AS "START_DATE" 
 , 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_msg_spec_corr_msg AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS P 
 ON S.MESSAGEREFID = P.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 WHERE S.ETL_RUN_ID > par_ERI_PROC; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 3; 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_repo_ent( 
 "MESSAGEREFID" 
 , "SENDINGENTITYIN" 
 , "TRANSMITTINGCOUNTRY" 
 , "REPORTINGPERIOD" 
 , "CBCBODYID" 
 , "DOCTYPEINDIC" 
 , "DOCREFID" 
 , "CORRDOCREFID" 
 , "CORRMESSAGEREFID" 
 , "REPORTINGROLE" 
 , "ISSUEDBY" 
 , "TIN" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "CMG_TD_NEGEER_INDICATIE" 
 , "CMG_TD_NEGEER_REDEN_CODE" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT S."MESSAGEREFID", 
 S."SENDINGENTITYIN", 
 S.TRANSMITTINGCOUNTRY, 
 P.REPORTINGPERIOD, 
 S."CBCBODYID", 
 S."DOCTYPEINDIC", 
 S."DOCREFID", 
 S."CORRDOCREFID", 
 S."CORRMESSAGEREFID", 
 S."REPORTINGROLE", 
 S."ISSUEDBY", 
 S."TIN", 
 S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 'N' AS "CMG_TD_NEGEER_INDICATIE", 
 NULL AS "CMG_TD_NEGEER_REDEN_CODE", 
 P.X_ONTVANGSTDATUMTIJD AS "START_DATE" 
 , 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_repo_ent AS S 
 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 ON S.MESSAGEREFID = C.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS P 
 ON S.MESSAGEREFID = P.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 WHERE S.X_OP_TYPE IN ('I', 'A') 
 AND S.DOCTYPEINDIC <> 'OECD0' 
 
 AND S.DOCTYPEINDIC <> 'OECD3' 
 
 AND C.PROCESS = 'Y' 
 AND S.ETL_RUN_ID > par_ERI_PROC; 
 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 4; 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_repo_ent AS T, 
 DG_I_O_40ANA_CBC.StCBCI_repo_ent AS S, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS P, 
 
 DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 SET "END_DATE" = P.X_ONTVANGSTDATUMTIJD - INTERVAL '1' SECOND 
 , "CURRENT_FLAG" = 'N' 
 
 WHERE T.DOCREFID = S.CORRDOCREFID 
 
 AND COALESCE(T.SENDINGENTITYIN, '') = COALESCE(S.SENDINGENTITYIN, '') 
 AND T.TRANSMITTINGCOUNTRY = S.TRANSMITTINGCOUNTRY 
 AND T.ETL_RUN_ID <= S.ETL_RUN_ID 
 
 
 AND S.MESSAGEREFID = P.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 AND C.PROCESS = 'Y' 
 AND TRIM(CONCAT(C.ETL_RUN_ID, '_', C.REPORTINGENTITYTIN)) NOT IN ('2049654_1133420984', '2049654_10753 29821') 
 
 
 
 
 AND T.END_DATE IS NULL 
 AND T.CURRENT_FLAG = 'Y'; 
 
 SET par_ACT_UPD = par_ACT_UPD + Activity_Count; 
 SET par_STEP = 17; 
 
 
 
 
 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents AS T, 
 DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_sum AS S 
 SET RESCOUNTRYCODE = S.RESCOUNTRYCODE 
 WHERE T.MESSAGEREFID = S.MESSAGEREFID 
 AND COALESCE(T.SENDINGENTITYIN,'') = COALESCE(S.SENDINGENTITYIN,'') 
 AND T.TRANSMITTINGCOUNTRY = S.TRANSMITTINGCOUNTRY 
 AND T.CBCBODYID = S.CBCBODYID 
 AND T.CBCREPORTID = S.CBCREPORTID 
 AND T.DOCREFID = S.DOCREFID 
 AND T.ETL_RUN_ID = S.ETL_RUN_ID 
 AND T.ETL_RUN_ID > par_ERI_PROC 
 AND T.RESCOUNTRYCODE IS NULL; 
 
 SET par_ACT_UPD = par_ACT_UPD + Activity_Count; 
 SET par_STEP = 18; 
 
 
 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_in( 
 "REPORTINGENTITYTIN" 
 , "CBCBODYID" 
 , "CBCREPORTID" 
 , "CONSTENTITYID" 
 , "DOCREFID" 
 , "CORRDOCREFID" 
 , "CORRMESSAGEREFID" 
 , "TIN" 
 , "ISSUEDBY" 
 , "INTYPE" 
 , "IN" 
 , "VOLGNR" 
 , "VOLGNR_COG" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "CMG_TD_NEGEER_INDICATIE" 
 , "CMG_TD_NEGEER_REDEN_CODE" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT S."REPORTINGENTITYTIN", 
 S."CBCBODYID", 
 S."CBCREPORTID", 
 S."CONSTENTITYID", 
 S."DOCREFID", 
 S."CORRDOCREFID", 
 S."CORRMESSAGEREFID", 
 S."TIN", 
 S."ISSUEDBY", 
 S."INTYPE", 
 S."IN", 
 S."VOLGNR", 
 RANK() OVER (PARTITION BY S.REPORTINGENTITYTIN, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.ETL_RUN_ID 
 ORDER BY S.VOLGNR) AS "VOLGNR_COG", 
 S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 'N' AS "CMG_TD_NEGEER_INDICATIE", 
 NULL AS "CMG_TD_NEGEER_REDEN_CODE", 
 P."START_DATE", 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_cnst_ent_in AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents AS P 
 ON COALESCE(S.REPORTINGENTITYTIN, '') = COALESCE(P.REPORTINGENTITYTIN, '') 
 AND S.DOCREFID = P.DOCREFID 
 AND COALESCE(S.CORRDOCREFID, '') = COALESCE(P.CORRDOCREFID, '') 
 AND S.CBCBODYID = P.CBCBODYID 
 AND S.CBCREPORTID = P.CBCREPORTID 
 AND S."CONSTENTITYID" = P."CONSTENTITYID" 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 ON P.MESSAGEREFID = C.MESSAGEREFID 
 AND COALESCE(P.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND P.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND P.ETL_RUN_ID = C.ETL_RUN_ID 
 AND P.CBCBODYID = C.CBCBODYID 
 WHERE S.X_OP_TYPE IN ('I', 'A') 
 AND C.PROCESS = 'Y' 
 AND S.ETL_RUN_ID > par_ERI_PROC 
 -- QUALIFY removed: RANK() OVER (PARTITION BY S.ETL_RUN_ID, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.VOLGNR 
 ORDER BY S.ETL_SEQ_ID) = 1; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 19; 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_in AS T, 
 
 ( 
 SELECT 
 DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 CBCBODYID, 
 DOCREFID, 
 CORRDOCREFID, 
 ETL_RUN_ID, 
 X_OP_TYPE 
 FROM DG_I_O_40ANA_CBC.StCBCI_cbcrepos_cnst_ents 
 WHERE ETL_RUN_ID > par_ERI_PROC 
 AND X_OP_TYPE IN ('A', 'D') ) AS S, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS M, 
 ( 
 SELECT 
 DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 DOCREFID, 
 CORRDOCREFID, 
 CBCBODYID, 
 ETL_RUN_ID 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents) AS P, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 SET "END_DATE" = M."X_ONTVANGSTDATUMTIJD" - INTERVAL '1' SECOND 
 , "CURRENT_FLAG" = 'N' 
 
 WHERE S.MESSAGEREFID = M.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(M.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = M.TRANSMITTINGCOUNTRY 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.CORRDOCREFID = P.DOCREFID 
 AND S.ETL_RUN_ID >= P.ETL_RUN_ID 
 
 AND P.DOCREFID = T.DOCREFID 
 AND COALESCE(P.CORRDOCREFID, '') = COALESCE(T.CORRDOCREFID, '') 
 AND P.CBCBODYID = T.CBCBODYID 
 AND P.ETL_RUN_ID = T.ETL_RUN_ID 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 AND C.PROCESS = 'Y' 
 
 
 
 AND T.END_DATE IS NULL 
 AND T.CURRENT_FLAG = 'Y'; 
 
 
 SET par_ACT_UPD = par_ACT_UPD + Activity_Count; 
 SET par_STEP = 20; 
 
 
 
 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_res_cntry( 
 "REPORTINGENTITYTIN" 
 , "CBCBODYID" 
 , "CBCREPORTID" 
 , "CONSTENTITYID" 
 , "DOCREFID" 
 , "CORRDOCREFID" 
 , "CORRMESSAGEREFID" 
 , "TIN" 
 , "RESCOUNTRYCODE" 
 , "VOLGNR" 
 , "VOLGNR_COG" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "CMG_TD_NEGEER_INDICATIE" 
 , "CMG_TD_NEGEER_REDEN_CODE" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT 
 S."REPORTINGENTITYTIN", 
 S."CBCBODYID", 
 S."CBCREPORTID", 
 S."CONSTENTITYID", 
 S."DOCREFID", 
 S."CORRDOCREFID", 
 S."CORRMESSAGEREFID", 
 S."TIN", 
 S."RESCOUNTRYCODE", 
 S."VOLGNR", 
 RANK() OVER (PARTITION BY S.REPORTINGENTITYTIN, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.ETL_RUN_ID 
 ORDER BY S.VOLGNR) AS "VOLGNR_COG", 
 S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 'N' AS "CMG_TD_NEGEER_INDICATIE", 
 NULL AS "CMG_TD_NEGEER_REDEN_CODE", 
 P."START_DATE", 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_cnst_ent_res_cntry AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents AS P 
 ON COALESCE(S.REPORTINGENTITYTIN, '') = COALESCE(P.REPORTINGENTITYTIN, '') 
 AND S.DOCREFID = P.DOCREFID 
 AND COALESCE(S.CORRDOCREFID, '') = COALESCE(P.CORRDOCREFID, '') 
 AND S.CBCBODYID = P.CBCBODYID 
 AND S.CBCREPORTID = P.CBCREPORTID 
 AND S."CONSTENTITYID" = P."CONSTENTITYID" 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 ON P.MESSAGEREFID = C.MESSAGEREFID 
 AND COALESCE(P.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND P.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND P.ETL_RUN_ID = C.ETL_RUN_ID 
 AND P.CBCBODYID = C.CBCBODYID 
 WHERE S.X_OP_TYPE IN ('I', 'A') 
 AND C.PROCESS = 'Y' 
 AND S.ETL_RUN_ID > par_ERI_PROC 
 QUALIFY RANK() OVER (PARTITION BY S.ETL_RUN_ID, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.VOLGNR 
 ORDER BY S.ETL_SEQ_ID) = 1; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 21; 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_res_cntry AS T, 
 
 ( 
 SELECT DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 CBCBODYID, 
 DOCREFID, 
 CORRDOCREFID, 
 ETL_RUN_ID, 
 X_OP_TYPE 
 FROM DG_I_O_40ANA_CBC.StCBCI_cbcrepos_cnst_ents 
 WHERE ETL_RUN_ID > par_ERI_PROC 
 AND X_OP_TYPE IN ('A', 'D') ) AS S, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS M, 
 ( 
 SELECT DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 DOCREFID, 
 CORRDOCREFID, 
 CBCBODYID, 
 ETL_RUN_ID 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents) AS P, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 SET "END_DATE" = M."X_ONTVANGSTDATUMTIJD" - INTERVAL '1' SECOND 
 , "CURRENT_FLAG" = 'N' 
 
 WHERE S.MESSAGEREFID = M.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(M.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = M.TRANSMITTINGCOUNTRY 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.CORRDOCREFID = P.DOCREFID 
 AND S.ETL_RUN_ID >= P.ETL_RUN_ID 
 
 AND P.DOCREFID = T.DOCREFID 
 AND COALESCE(P.CORRDOCREFID, '') = COALESCE(T.CORRDOCREFID, '') 
 AND P.CBCBODYID = T.CBCBODYID 
 AND P.ETL_RUN_ID = T.ETL_RUN_ID 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 AND C.PROCESS = 'Y' 
 AND TRIM(CONCAT(C.ETL_RUN_ID, '_', C.REPORTINGENTITYTIN)) NOT IN ('2049654_1133420984', '2049654_10753 29821') 
 
 
 
 AND T.END_DATE IS NULL 
 AND T.CURRENT_FLAG = 'Y'; 
 
 SET par_ACT_UPD = par_ACT_UPD + Activity_Count; 
 SET par_STEP = 22; 
 
 
 
 
 
 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_biz_acts( 
 "REPORTINGENTITYTIN" 
 , "CBCBODYID" 
 , "CBCREPORTID" 
 , "CONSTENTITYID" 
 , "DOCREFID" 
 , "CORRDOCREFID" 
 , "CORRMESSAGEREFID" 
 , "TIN" 
 , "BIZZACTIVITIES" 
 , "VOLGNR" 
 , "VOLGNR_COG" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "CMG_TD_NEGEER_INDICATIE" 
 , "CMG_TD_NEGEER_REDEN_CODE" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT 
 S."REPORTINGENTITYTIN", 
 S."CBCBODYID", 
 S."CBCREPORTID", 
 S."CONSTENTITYID", 
 S."DOCREFID", 
 S."CORRDOCREFID", 
 S."CORRMESSAGEREFID", 
 S."TIN", 
 S."BIZZACTIVITIES", 
 S."VOLGNR", 
 RANK() OVER (PARTITION BY S.REPORTINGENTITYTIN, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.ETL_RUN_ID 
 ORDER BY S.VOLGNR) AS "VOLGNR_COG", 
 S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 'N' AS "CMG_TD_NEGEER_INDICATIE", 
 NULL AS "CMG_TD_NEGEER_REDEN_CODE", 
 P."START_DATE", 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_cnst_ent_biz_acts AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents AS P 
 ON COALESCE(S.REPORTINGENTITYTIN, '') = COALESCE(P.REPORTINGENTITYTIN, '') 
 AND S.DOCREFID = P.DOCREFID 
 AND COALESCE(S.CORRDOCREFID, '') = COALESCE(P.CORRDOCREFID, '') 
 AND S.CBCBODYID = P.CBCBODYID 
 AND S.CBCREPORTID = P.CBCREPORTID 
 AND S."CONSTENTITYID" = P."CONSTENTITYID" 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 ON P.MESSAGEREFID = C.MESSAGEREFID 
 AND COALESCE(P.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND P.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND P.ETL_RUN_ID = C.ETL_RUN_ID 
 AND P.CBCBODYID = C.CBCBODYID 
 WHERE S.X_OP_TYPE IN ('I', 'A') 
 AND C.PROCESS = 'Y' 
 AND S.ETL_RUN_ID > par_ERI_PROC 
 QUALIFY RANK() OVER (PARTITION BY S.ETL_RUN_ID, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.VOLGNR 
 ORDER BY S.ETL_SEQ_ID) = 1; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 23; 
 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_biz_acts AS T, 
 
 ( 
 SELECT 
 DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 CBCBODYID, 
 DOCREFID, 
 CORRDOCREFID, 
 ETL_RUN_ID, 
 X_OP_TYPE 
 FROM DG_I_O_40ANA_CBC.StCBCI_cbcrepos_cnst_ents 
 WHERE ETL_RUN_ID > par_ERI_PROC 
 AND X_OP_TYPE IN ('A', 'D') ) AS S, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS M, 
 ( 
 SELECT 
 DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 DOCREFID, 
 CORRDOCREFID, 
 CBCBODYID, 
 ETL_RUN_ID 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents) AS P, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 SET "END_DATE" = M."X_ONTVANGSTDATUMTIJD" - INTERVAL '1' SECOND 
 , "CURRENT_FLAG" = 'N' 
 
 WHERE S.MESSAGEREFID = M.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(M.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = M.TRANSMITTINGCOUNTRY 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.CORRDOCREFID = P.DOCREFID 
 AND S.ETL_RUN_ID >= P.ETL_RUN_ID 
 
 AND P.DOCREFID = T.DOCREFID 
 AND COALESCE(P.CORRDOCREFID, '') = COALESCE(T.CORRDOCREFID, '') 
 AND P.CBCBODYID = T.CBCBODYID 
 AND P.ETL_RUN_ID = T.ETL_RUN_ID 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 AND C.PROCESS = 'Y' 
 AND TRIM(CONCAT(C.ETL_RUN_ID, '_', C.REPORTINGENTITYTIN)) NOT IN ('2049654_1133420984', '2049654_10753 29821') 
 
 
 
 
 AND T.END_DATE IS NULL 
 AND T.CURRENT_FLAG = 'Y'; 
 
 SET par_ACT_UPD = par_ACT_UPD + Activity_Count; 
 SET par_STEP = 24; 
 
 
 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_adrs( 
 "REPORTINGENTITYTIN" 
 , "CBCBODYID" 
 , "CBCREPORTID" 
 , "CONSTENTITYID" 
 , "DOCREFID" 
 , "CORRDOCREFID" 
 , "CORRMESSAGEREFID" 
 , "TIN" 
 , "LEGALADDRESSTYPE" 
 , "COUNTRYCODE" 
 , "ADDRESSFREE" 
 , "STREET" 
 , "BUILDINGIDENTIFIER" 
 , "SUITEIDENTIFIER" 
 , "FLOORIDENTIFIER" 
 , "DISTRICTNAME" 
 , "POB" 
 , "POSTCODE" 
 , "CITY" 
 , "COUNTRYSUBENTITY" 
 , "VOLGNR" 
 , "VOLGNR_COG" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "CMG_TD_NEGEER_INDICATIE" 
 , "CMG_TD_NEGEER_REDEN_CODE" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT 
 S."REPORTINGENTITYTIN", 
 S."CBCBODYID", 
 S."CBCREPORTID", 
 S."CONSTENTITYID", 
 S."DOCREFID", 
 S."CORRDOCREFID", 
 S."CORRMESSAGEREFID", 
 S."TIN", 
 S."LEGALADDRESSTYPE", 
 S."COUNTRYCODE", 
 S."ADDRESSFREE", 
 S."STREET", 
 S."BUILDINGIDENTIFIER", 
 S."SUITEIDENTIFIER", 
 S."FLOORIDENTIFIER", 
 S."DISTRICTNAME", 
 S."POB", 
 S."POSTCODE", 
 S."CITY", 
 S."COUNTRYSUBENTITY", 
 S."VOLGNR", 
 RANK() OVER (PARTITION BY S.REPORTINGENTITYTIN, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.ETL_RUN_ID 
 ORDER BY S.VOLGNR) AS "VOLGNR_COG", 
 S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 'N' AS "CMG_TD_NEGEER_INDICATIE", 
 NULL AS "CMG_TD_NEGEER_REDEN_CODE", 
 P."START_DATE", 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_cnst_ent_adrs AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents AS P 
 ON COALESCE(S.REPORTINGENTITYTIN, '') = COALESCE(P.REPORTINGENTITYTIN, '') 
 AND S.DOCREFID = P.DOCREFID 
 AND COALESCE(S.CORRDOCREFID, '') = COALESCE(P.CORRDOCREFID, '') 
 AND S.CBCBODYID = P.CBCBODYID 
 AND S.CBCREPORTID = P.CBCREPORTID 
 AND S."CONSTENTITYID" = P."CONSTENTITYID" 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 ON P.MESSAGEREFID = C.MESSAGEREFID 
 AND COALESCE(P.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND P.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND P.ETL_RUN_ID = C.ETL_RUN_ID 
 AND P.CBCBODYID = C.CBCBODYID 
 WHERE S.X_OP_TYPE IN ('I', 'A') 
 AND C.PROCESS = 'Y' 
 AND S.ETL_RUN_ID > par_ERI_PROC 
 QUALIFY RANK() OVER (PARTITION BY S.ETL_RUN_ID, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.VOLGNR 
 ORDER BY S.ETL_SEQ_ID) = 1; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 25; 
 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_adrs AS T, 
 
 ( 
 SELECT 
 DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 CBCBODYID, 
 DOCREFID, 
 CORRDOCREFID, 
 ETL_RUN_ID, 
 X_OP_TYPE 
 FROM DG_I_O_40ANA_CBC.StCBCI_cbcrepos_cnst_ents 
 WHERE ETL_RUN_ID > par_ERI_PROC 
 AND X_OP_TYPE IN ('A', 'D') ) AS S, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS M, 
 ( 
 SELECT 
 DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 DOCREFID, 
 CORRDOCREFID, 
 CBCBODYID, 
 ETL_RUN_ID 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents) AS P, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 SET "END_DATE" = M."X_ONTVANGSTDATUMTIJD" - INTERVAL '1' SECOND 
 , "CURRENT_FLAG" = 'N' 
 
 WHERE S.MESSAGEREFID = M.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(M.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = M.TRANSMITTINGCOUNTRY 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.CORRDOCREFID = P.DOCREFID 
 AND S.ETL_RUN_ID >= P.ETL_RUN_ID 
 
 AND P.DOCREFID = T.DOCREFID 
 AND COALESCE(P.CORRDOCREFID, '') = COALESCE(T.CORRDOCREFID, '') 
 AND P.CBCBODYID = T.CBCBODYID 
 AND P.ETL_RUN_ID = T.ETL_RUN_ID 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 AND C.PROCESS = 'Y' 
 AND TRIM(CONCAT(C.ETL_RUN_ID, '_', C.REPORTINGENTITYTIN)) NOT IN ('2049654_1133420984', '2049654_10753 29821') 
 
 
 
 AND T.END_DATE IS NULL 
 AND T.CURRENT_FLAG = 'Y'; 
 
 SET par_ACT_UPD = par_ACT_UPD + Activity_Count; 
 SET par_STEP = 26; 
 
 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_name( 
 "REPORTINGENTITYTIN" 
 , "CBCBODYID" 
 , "CBCREPORTID" 
 , "CONSTENTITYID" 
 , "DOCREFID" 
 , "CORRDOCREFID" 
 , "CORRMESSAGEREFID" 
 , "TIN" 
 , "NAME" 
 , "VOLGNR" 
 , "VOLGNR_COG" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "CMG_TD_NEGEER_INDICATIE" 
 , "CMG_TD_NEGEER_REDEN_CODE" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG") 
 SELECT 
 S."REPORTINGENTITYTIN", 
 S."CBCBODYID", 
 S."CBCREPORTID", 
 S."CONSTENTITYID", 
 S."DOCREFID", 
 S."CORRDOCREFID", 
 S."CORRMESSAGEREFID", 
 S."TIN", 
 S."NAME", 
 S."VOLGNR", 
 RANK() OVER (PARTITION BY S.REPORTINGENTITYTIN, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.ETL_RUN_ID 
 ORDER BY S.VOLGNR) AS "VOLGNR_COG", 
 S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 'N' AS "CMG_TD_NEGEER_INDICATIE", 
 NULL AS "CMG_TD_NEGEER_REDEN_CODE", 
 P."START_DATE", 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG" 
 FROM DG_I_O_40ANA_CBC.StCBCI_cnst_ent_name AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents AS P 
 ON COALESCE(S.REPORTINGENTITYTIN, '') = COALESCE(P.REPORTINGENTITYTIN, '') 
 AND S.DOCREFID = P.DOCREFID 
 AND COALESCE(S.CORRDOCREFID, '') = COALESCE(P.CORRDOCREFID, '') 
 AND S.CBCBODYID = P.CBCBODYID 
 AND S.CBCREPORTID = P.CBCREPORTID 
 AND S."CONSTENTITYID" = P."CONSTENTITYID" 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 ON P.MESSAGEREFID = C.MESSAGEREFID 
 AND COALESCE(P.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND P.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND P.ETL_RUN_ID = C.ETL_RUN_ID 
 AND P.CBCBODYID = C.CBCBODYID 
 WHERE S.X_OP_TYPE IN ('I', 'A') 
 AND C.PROCESS = 'Y' 
 AND S.ETL_RUN_ID > par_ERI_PROC 
 QUALIFY RANK() OVER (PARTITION BY S.ETL_RUN_ID, S.CBCBODYID, S.CBCREPORTID, S.CONSTENTITYID, S.DOCREFID, S.VOLGNR 
 ORDER BY S.ETL_SEQ_ID) = 1; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 27; 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cnst_ent_name AS T, 
 
 ( 
 SELECT 
 DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 CBCBODYID, 
 DOCREFID, 
 CORRDOCREFID, 
 ETL_RUN_ID, 
 X_OP_TYPE 
 FROM DG_I_O_40ANA_CBC.StCBCI_cbcrepos_cnst_ents 
 WHERE ETL_RUN_ID > par_ERI_PROC 
 AND X_OP_TYPE IN ('A', 'D') ) AS S, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS M, 
 ( 
 SELECT DISTINCT MESSAGEREFID, 
 SENDINGENTITYIN, 
 TRANSMITTINGCOUNTRY, 
 DOCREFID, 
 CORRDOCREFID, 
 CBCBODYID, 
 ETL_RUN_ID 
 FROM DG_I_O_40ANA_CBC.DpCBCD_cbcrepos_cnst_ents) AS P, 
 DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 SET "END_DATE" = M."X_ONTVANGSTDATUMTIJD" - INTERVAL '1' SECOND 
 , "CURRENT_FLAG" = 'N' 
 
 WHERE S.MESSAGEREFID = M.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(M.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = M.TRANSMITTINGCOUNTRY 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.CORRDOCREFID = P.DOCREFID 
 AND S.ETL_RUN_ID >= P.ETL_RUN_ID 
 
 AND P.DOCREFID = T.DOCREFID 
 AND COALESCE(P.CORRDOCREFID, '') = COALESCE(T.CORRDOCREFID, '') 
 AND P.CBCBODYID = T.CBCBODYID 
 AND P.ETL_RUN_ID = T.ETL_RUN_ID 
 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 AND C.PROCESS = 'Y' 
 AND TRIM(CONCAT(C.ETL_RUN_ID, '_', C.REPORTINGENTITYTIN)) NOT IN ('2049654_1133420984', '2049654_10753 29821') 
 
 
 
 AND T.END_DATE IS NULL 
 AND T.CURRENT_FLAG = 'Y'; 
 
 SET par_ACT_UPD = par_ACT_UPD + Activity_Count; 
 SET par_STEP = 28; 
 
 
 
 
 
 
 
 INSERT INTO DG_I_O_40ANA_CBC.DpCBCD_add_info( 
 "MESSAGEREFID" 
 , "SENDINGENTITYIN" 
 , "TRANSMITTINGCOUNTRY" 
 , "REPORTINGPERIOD" 
 , "REPORTINGENTITYTIN" 
 , "CBCBODYID" 
 , "ADINFOID" 
 , "DOCTYPEINDIC" 
 , "DOCREFID" 
 , "CORRDOCREFID" 
 , "CORRMESSAGEREFID" 
 , "OTHERINFO" 
 , "ETL_RUN_ID" 
 , "ETL_STG_TIMESTAMP" 
 , "CMG_TD_NEGEER_INDICATIE" 
 , "CMG_TD_NEGEER_REDEN_CODE" 
 , "START_DATE" 
 , "END_DATE" 
 , "CURRENT_FLAG" 
 , COG_RUN_ID) 
 SELECT 
 S."MESSAGEREFID", 
 S."SENDINGENTITYIN", 
 S."TRANSMITTINGCOUNTRY", 
 P.REPORTINGPERIOD, 
 S."REPORTINGENTITYTIN", 
 S."CBCBODYID", 
 S."ADINFOID", 
 S."DOCTYPEINDIC", 
 S."DOCREFID", 
 S."CORRDOCREFID", 
 S."CORRMESSAGEREFID", 
 S."OTHERINFO", 
 S."ETL_RUN_ID", 
 S."ETL_STG_TIMESTAMP", 
 'N' AS "CMG_TD_NEGEER_INDICATIE", 
 NULL AS "CMG_TD_NEGEER_REDEN_CODE", 
 P."X_ONTVANGSTDATUMTIJD" AS "START_DATE", 
 NULL AS "END_DATE", 
 'Y' AS "CURRENT_FLAG", 
 par_COG_RUN_ID AS COG_RUN_ID 
 FROM DG_I_O_40ANA_CBC.StCBCI_add_info AS S 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS P 
 ON S.MESSAGEREFID = P.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(P.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = P.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = P.ETL_RUN_ID 
 
 INNER JOIN DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 ON S.MESSAGEREFID = C.MESSAGEREFID 
 AND COALESCE(S.SENDINGENTITYIN, '') = COALESCE(C.SENDINGENTITYIN, '') 
 AND S.TRANSMITTINGCOUNTRY = C.TRANSMITTINGCOUNTRY 
 AND S.ETL_RUN_ID = C.ETL_RUN_ID 
 AND S.CBCBODYID = C.CBCBODYID 
 WHERE S.X_OP_TYPE IN ('I', 'A') 
 AND C.PROCESS = 'Y' 
 AND S.ETL_RUN_ID > par_ERI_PROC 
 QUALIFY RANK() OVER (PARTITION BY S.ETL_RUN_ID, S.CBCBODYID, S.ADINFOID 
 ORDER BY S.ETL_SEQ_ID) = 1; 
 
 SET par_ACT_INS = par_ACT_INS + Activity_Count; 
 SET par_STEP = 29; 
 
 
 
 UPDATE T 
 FROM DG_I_O_40ANA_CBC.DpCBCD_add_info AS T, 
 ( 
 SELECT DISTINCT ETL_RUN_ID, 
 CBCBODYID, 
 TRANSMITTINGCOUNTRY, 
 SENDINGENTITYIN, 
 MESSAGEREFID, 
 CORRDOCREFID 
 FROM DG_I_O_40ANA_CBC.StCBCI_add_info 
 WHERE X_OP_TYPE IN ('A', 'D') 
 AND ETL_RUN_ID > par_ERI_PROC) AS S, 
 
 DG_I_O_40ANA_CBC.DpCBCD_msg_spec AS P, 
 
 DG_I_O_40ANA_CBC.DpCBCD_msg_proc_val AS C 
 SET "END_DATE" = P."X_ONTVANGSTDATUMTIJD" - INTERVAL '1' SECOND 
 , "CURRENT_FLAG" = 'N' 
 
 SET par_STATUS = 0; 
 END@
